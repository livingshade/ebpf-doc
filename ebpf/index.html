<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://example.com/ebpf/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>eBPF overview - ebpf Docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "eBPF overview";
        var mkdocs_page_input_path = "ebpf.md";
        var mkdocs_page_url = "/ebpf/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> ebpf Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">eBPF overview</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#hook">Hook</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#bpf-instructions-and-helper-functions">BPF instructions and helper functions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#bpf-maps">BPF maps</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#load-bpf-programs">load BPF programs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#bpf-relocations">BPF relocations</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../doc/">source level document</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rcore/">rCore tutoria migration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../zcore/">zCore reproduce guide</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">ebpf Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>eBPF overview</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="ebpf-strcuture">eBPF strcuture</h1>
<p>eBPF is bascially a method for user to run a program in kernel space.</p>
<p>User needs to choose a hookpoint(some kernel functions) and the bpf program. Program should consits only limited eBPF instructions, and the program will be executed when the hookpoint is triggered.</p>
<p>To achieve that, kernel needs to provide a way to load program into kernel, a bridge to transfer data between user space and kernel space(BPF maps). In Linux, a dedicated BPF syscall is provided. We will use the same API as Linux, but the implementation is different and much simple.</p>
<h2 id="hook">Hook</h2>
<p>In Linux kernel, eBPF is widely applied in network stack.(i.e. xDP) However, given that some Rust-based OS does not implment netowrk stack, we use kprobes as hookpoint.</p>
<p>Since eBPF does not care about the hookpoints, it only needs a instruction to call the BPF program, and, provide necessary contexts. One could imagine that the hookpoint is something like <code>call $bpf_program(arg0 = context)</code>. And for kprobes, the context is the registers.</p>
<p>Thus, the implmentation detail of kprobes is not the focus of this project, so we will not discuss it here. One should refer to <a href="https://cubele.github.io/probe-docs/ebpf%E7%A7%BB%E6%A4%8D/kprobes/%E5%AE%9E%E7%8E%B0/">this blog</a> for more information.</p>
<h2 id="overview">Overview</h2>
<p>As discussed above, eBPF is a method for user to run a program in kernel space. The program is loaded by a syscall, and the program will be executed when the hookpoint is triggered. The program is a set of instructions, and the program can access data in kernel space through BPF maps. So, for any OS, we need the following components:</p>
<ul>
<li>A new bpf syscall</li>
<li>Kernel memory to store the BPF programs and BPF maps</li>
<li>The actual implementation of abstract functionalities</li>
</ul>
<p>We will talk about the last component, since the first two are OS-dependent.</p>
<h3 id="bpf-instructions-and-helper-functions">BPF instructions and helper functions</h3>
<p>BPF codes are executed in bytecode, and an ISA is provided <a href="https://docs.kernel.org/bpf/instruction-set.html">here</a>. The instruction set is very limited, and it is designed to be safe.</p>
<p>Since the BPF instruction are limited, the kernel needs to provide some special helper functions for BPF program to use. For example, <code>bpf_helper_printk</code> is a helper function that prints a string to kernel log. Thus user can read the output to know what is happening.</p>
<p>But writing assembly code is hard. So we write C code and use clang to compile it to BPF bytecode. And the helper functions are just symbols in user codes, kernel needs to relocate them to the actual address.</p>
<h3 id="bpf-maps">BPF maps</h3>
<p>A BPF map a key-value store in kernel space. The key and value are both fixed size, and the size is defined when the map is created. The map is created by the syscall, and the map is identified by a file descriptor.</p>
<p>Note that the communication between BPF program and maps are through file descriptors and helper functions like <code>bpf_helper_map_lookup_elem</code>.</p>
<p>There is only two kinds of maps <code>Array</code> and <code>HashTable</code> and their per-CPU version. The difference between <code>Array</code> and <code>HashTable</code> is that <code>Array</code> is indexed by a number, and <code>HashTable</code> is indexed by a key. We omit the per-CPU version and use mutex for concurrency.</p>
<p>The maps are no different from their user space correspondant, except that the map is in kernel space. You could refer to the source code section <a href="../zcore/">here</a> for more information.</p>
<h3 id="load-bpf-programs">load BPF programs</h3>
<p>A BPF program some thing that user wants to execuate in kernel space. The user program will send the bytecode to kernel space, and the kernel will first verify the bytecode for safty concern. There are also some relocation needs to be. And then the code is JITed into machine code and stored in kernel space. So, it looks like:</p>
<pre><code class="language-c">void *bpf_prog_load(void *prog, size_t prog_len) {
    if (!verify_and_relocate(prog, prog_len)) {
        return NULL;
    }
    void *machine_code = jit(prog, prog_len);
    return machine_code;
}
</code></pre>
<p>And when the program needs to be executed, the <code>machine_code</code> is cast to a function pointer and called.</p>
<p>We won't talk about JIT here. We simple take them as library. One could refer to original JIT repo <a href="https://github.com/latte-c/ebpf2rv">here</a>. For verification, we just skip them. You can refer to  <a href="https://yesh0.github.io/ebpf-analyzer/">eBPF hitch hiking blog</a> for information about verification.</p>
<h3 id="bpf-relocations">BPF relocations</h3>
<p>We can skip verification, but we can't skip relocation. The relocation is needed mainly because the program is loaded into kernel space, and the program needs to access the BPF maps.BPF helper functions also need to be relocated.</p>
<p>Note that in Linux kernel, the relocation and verification are coupled and it is more than maps and helpers that needs to be relocated. And some relocations are done in user space by libbpf. For simplicity, we will not discuss it here, but again you could refer to <a href="https://yesh0.github.io/ebpf-analyzer/">eBPF hitch hiking blog</a>.</p>
<h1 id="code-structure">Code structure</h1>
<p>The basic code structure is as follows:</p>
<pre><code class="language-bash">src
│   mod.rs
│   .... # those are unrelated to eBPF
│
└───ebpf
│   │   mod.rs
│   │   osutil.rs
│   │   program.rs
│   │   tracepoints.rs
│   │   retcode.rs
│   │   consts.rs
│   │   helpers.rs
│   │
│   └───map
│       │   mod.rs
│       │   internal.rs
│       │   hash.rs
│       │   array.rs
</code></pre>
<p>You should modify the OS-level syscall, check the <code>BpfCommand</code> in <code>consts.rs</code> and redirect those function to <code>sys_bpf_*</code> in <code>osutil.rs</code>.</p>
<p>Most of files should be OS-independent.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../doc/" class="btn btn-neutral float-right" title="source level document">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../doc/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
